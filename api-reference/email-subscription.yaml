openapi: 3.0.3
info:
  title: MoEngage Email Subscription Management APIs
  description: APIs for managing user email resubscription and opt-in status.
  version: '1.0'
servers:
  - url: 'https://api-0{X}.moengage.com'
    description: MoEngage API Server
    variables:
      X:
        default: '1'
        description: 'Your MoEngage Data Center (DC) number. Refer to MoEngage docs for your correct DC.'
tags:
  - name: Resubscribe
    description: Resubscribe users who previously unsubscribed.
  - name: Opt-in Management
    description: Update user email opt-in status.
security:
  - basicAuth: []
paths:
  /emails/v1.0/bulk-resubscribe:
    post:
      tags:
        - Resubscribe
      summary: Bulk Resubscribe Users
      description: |
        Resubscribes users who have previously unsubscribed on the MoEngage platform and (optionally) an external ESP platform (currently SendGrid).
        Resets the unsubscribe flag to "false" for users on MoEngage.
        If `update_esp` is true, makes a call to the specified ESP (SendGrid) to remove email addresses from their suppression list.
        Rate Limit: 10 RPM, 14.4K requests/day, max 100 recipients per request.
      operationId: bulkResubscribeUsers
      parameters:
        - name: MOE-APPKEY
          in: header
          required: true
          schema:
            type: string
          description: 'This is the WORKSPACE ID of your MoEngage account. Found in Settings -> Account -> APIs -> WORKSPACE ID.'
          example: 'YOUR_WORKSPACE_ID_XXXX'
      requestBody:
        description: List of recipients to resubscribe.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResubscribeRequest'
            example:
              recipients:
                - jane@domain.com
                - mike@example.com
                - john.doe@example.com
              update_esp: true
              esp: SENDGRID
              request_id: '636b77e6e2cf83277195fb60'
      responses:
        '202':
          description: The request is submitted successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeSuccessResponse'
              example:
                message: The request is submitted successfully.
                response_id: SrTuWVlPsq
        '400':
          description: Bad Request (e.g., missing fields, invalid format, too many recipients, invalid ESP settings).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeErrorResponse'
              examples:
                missingRecipients:
                  summary: Missing recipients field
                  value:
                    response_id: wkskLzEMwM
                    error:
                      message: Request_Body is mandatory. Kindly add request_body and the desired fields in the API payload.
                      err_code: BadRequest
                missingRequestId:
                  summary: Missing request_id field
                  value:
                    response_id: jLcIFgNqiF
                    error:
                      message: request_id - Field is required but value is None
                      err_code: InvalidFieldValue
                tooManyRecipients:
                  summary: Too many recipients (>100)
                  value:
                    response_id: ofVaFGNZeU
                    error:
                      message: Payload limit is set to 100
                      err_code: BadRequest
                invalidRecipientFormat:
                  summary: Invalid email format in recipients
                  value:
                    response_id: CNjLIXzCxP
                    error:
                      message: Please provide input in a valid email address format (example@domain.com) as part of 'Recipients'.
                      err_code: InvalidInput
                emptyRecipients:
                  summary: Empty recipients array
                  value:
                    response_id: VkJTiAOgxt
                    error:
                      message: Add at least one email address as part of the 'Recipients'
                      err_code: InvalidInput
                invalidEspSettings:
                  summary: Invalid Email Connector Settings
                  description: Occurs if the configured ESP settings are incorrect when `update_esp` is true.
                  value:
                    # FIXME: Example structure based on description, confirm actual response format
                    response_id: GENERATED_ID
                    error:
                       message: Valid email settings not present
                       err_code: InvalidSettings # FIXME: Confirm actual error code
        '401':
          description: Authorization Failure (e.g., header mismatch, key missing/invalid, auth type invalid).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeErrorResponse'
              examples:
                headerMismatch:
                  summary: MOE-APPKEY mismatch
                  value:
                    response_id: YNJhkZzfqt
                    error:
                      message: MOE_APPKEY doesn't match the Username (APP_KEY) used in Basic Auth authorization.
                      err_code: HeaderMismatch
                missingPassword:
                  summary: Missing password in Basic Auth
                  value:
                    response_id: dKzDpSIiCG
                    error:
                      message: Password (APP_SECRET) is missing in the Basic Auth authorization.
                      err_code: AuthenticationMissing
        '405':
          description: Method Not Allowed (e.g., using GET instead of POST).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeErrorResponse'
              example:
                response_id: GudkCOBkHT
                error:
                  message: This API only supports the POST method. Kindly update the method and retry again.
                  err_code: MethodNotAllowed
        '415':
          description: Unsupported Media Type (e.g., missing/invalid Content-Type header).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeErrorResponse'
              example:
                response_id: quUXnIinLK
                error:
                  message: The header 'Content-Type' is missing. Kindly provide the header 'Content-Type' and set it as 'application/json'
                  err_code: HeaderMissing
        '429':
          description: Rate Limit Breach (10 RPM).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeErrorResponse'
              example:
                response_id: quUXnIinLK
                error:
                  message: Rate limit exceeded
                  err_code: TooManyRequests
        '500':
          description: Internal Server Error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeErrorResponse'
              example:
                response_id: quUXnIinLK
                error:
                  message: Please Contact Moengage Team
                  err_code: INTERNAL_SERVER_ERROR

  /v1.0/opt-in-management/user-preferences:
    put:
      tags:
        - Opt-in Management
      summary: Update User Email Opt-in Preferences
      description: |
        Updates the user's email opt-in status and category preferences in MoEngage after they submit the second confirmation through MoEngage consent-seeking emails.
        Rate Limit: 1000 RPM, 360k per day.
      operationId: updateEmailOptinPreferences
      parameters:
        - name: MOE-APPKEY
          in: header
          required: true
          schema:
            type: string
          description: 'This is the WORKSPACE ID of your MoEngage account. Found in Settings -> Account -> APIs -> WORKSPACE ID.'
          example: 'YOUR_WORKSPACE_ID_XXXX'
      requestBody:
        description: User preference details.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OptinRequest'
            example:
              user_preferences:
                customer_id: ID_uid
                email_id: john@example.com
                categories:
                  category_1: true
                  category_2: false
                opt_in_status: DOUBLE_OPTED_IN
                channel: email
      responses:
        '200':
          description: Your request has been processed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptinSuccessResponse'
              example:
                message: Your request has been processed successfully
        '400':
          description: Bad Request (e.g., invalid data types, extra keys, invalid enums, missing id/email, invalid categories, user not found).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptinErrorResponse'
              examples:
                invalidDataType:
                  summary: Invalid Data Type
                  value:
                    error:
                      code: 400 Bad Request
                      message: Request Data is invalid.
                      details:
                        target: customer_id
                        message: "Wrong data type was used for <customer_id> - Value must be of type (<class 'str'>,), passed type: <class 'bool'> : False."
                invalidOptInStatus:
                  summary: Invalid Opt-in Status Value
                  value:
                    error:
                      code: 400 Bad Request
                      message: Request Data is invalid
                      details:
                        target: opt_in_status
                        message: "Opt-In status can only be 'DOUBLE_OPTED_IN' or 'OPTED_OUT' or 'OPT_IN_PENDING' (case-insensitive). Please provide the correct value."
                missingIdOrEmail:
                  summary: Missing customer_id or email_id
                  value:
                    error:
                      code: 400 Bad Request
                      message: Request Data is invalid
                      details:
                        target: customer_id or email_id
                        message: Either customer_id or email_id is mandatory. Please provide at least one of them.
                userNotFound:
                  summary: User Not Found
                  value:
                    error:
                      code: 400 Bad Request
                      message: Request Data is invalid
                      details:
                        target: customer_id or email_id
                        message: No users found with the provided customer_id or email_id. Please check the same.
                invalidCategory:
                  summary: Invalid or Inactive Category
                  value:
                    error:
                      code: 400 Bad Request
                      message: Request Data is invalid
                      details:
                        target: categories
                        message: Categories A, B, C are either invalid or not active in the Workspace. Please check the categories in the request.
        '401':
          description: Unauthorized (Authentication failed, header mismatch, invalid/missing keys).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptinErrorResponse'
              examples:
                missingAuthHeader:
                  summary: Missing Authorization Header
                  value:
                    error:
                      code: 401 Unauthorized
                      message: Authentication failed.
                      details:
                        target: Authorization Header
                        message: Authorization header is missing
                wrongDataKey:
                  summary: Wrong Data API Key
                  value:
                    error:
                      code: 401 Unauthorized
                      message: Authentication failed
                      details:
                        target: Data key
                        message: Data API key is wrong. Please provide correct Data API Key as password.
        '403':
          description: Forbidden (Feature not enabled for the workspace).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptinErrorResponse'
              example:
                error:
                  code: 403 Forbidden
                  message: Feature not enabled
                  details:
                    target: Email Opt-in Management
                    message: Email Opt-in Management feature not enabled for the workspace. Please reach out to MoEngage to get it enabled.
        '429':
          description: Too Many Requests (Rate limit breached - 1000 RPM / 360k per day). No response body.
          content: {}
        '500':
          description: Internal Server Error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptinError500Response'
              example:
                error:
                  code: 500 Internal Server Error
                  message: Something went wrong, Please contact MoEngage Team.

components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: 'Basic Authentication using Workspace ID (username) and Data API Key (password) from MoEngage Dashboard > Settings > Account > APIs.'
  schemas:
    # Resubscribe Schemas
    ResubscribeRequest:
      type: object
      required:
        - recipients
        - esp
        - request_id
      properties:
        recipients:
          type: array
          items:
            type: string
            format: email
          description: Email IDs of users who have resubscribed. Max 100 per request.
          maxItems: 100
          example: ["john@example.com", "mike@example.com"]
        esp:
          type: string
          description: Email Service Provider whose suppression list needs to be updated. Currently only supports SENDGRID.
          enum: [SENDGRID]
          example: SENDGRID
        update_esp:
          type: boolean
          description: If true, MoEngage calls the ESP to remove email addresses from their suppression list. Defaults to false.
          default: false
        request_id:
          type: string
          description: Unique identifier for the request.
          example: '636b77e6e2cf83277195fb60'
    ResubscribeSuccessResponse:
      type: object
      properties:
        message:
          type: string
          example: The request is submitted successfully.
        response_id:
          type: string
          example: SrTuWVlPsq
    ResubscribeErrorResponse:
      type: object
      properties:
        response_id:
          type: string
        error:
          type: object
          properties:
            message:
              type: string
            err_code:
              type: string

    # Opt-in Management Schemas
    OptinRequest:
      type: object
      required:
        - user_preferences
      properties:
        user_preferences:
          $ref: '#/components/schemas/UserPreferences'
    UserPreferences:
      type: object
      description: Contains the user's opt-in preferences. Must contain either customer_id or email_id.
      required:
        - opt_in_status
        - channel
      properties:
        customer_id:
          type: string
          description: Unique identifier for the user in MoEngage. Optional if email_id is provided.
          example: ID_uid
        email_id:
          type: string
          format: email
          description: Email ID of the user. Optional if customer_id is provided. If only email_id is provided, all users with this email may be updated (contact MoEngage support to configure behavior).
          example: john@example.com
        categories:
          type: object
          description: Subscription status for defined categories. Keys are category names, values are boolean (true=subscribed). Invalid/inactive categories will cause the request to fail.
          additionalProperties:
            type: boolean
          example:
            category_1: true
            category_2: false
        opt_in_status:
          type: string
          description: The user's overall opt-in status. Case-insensitive. If all categories are false, this will be overridden to OPTED_OUT even if DOUBLE_OPTED_IN is passed.
          enum: [DOUBLE_OPTED_IN, OPTED_OUT, OPT_IN_PENDING]
          example: DOUBLE_OPTED_IN
        channel:
          type: string
          description: The channel for which the opt-in status applies. Currently only supports 'email'.
          enum: [email]
          example: email
    OptinSuccessResponse:
      type: object
      properties:
        message:
          type: string
          example: Your request has been processed successfully
    OptinErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: 400 Bad Request
            message:
              type: string
              example: Request Data is invalid.
            details:
              type: object
              properties:
                target:
                  type: string
                  example: customer_id
                message:
                  type: string
                  example: "Wrong data type was used for <customer_id>..."
    OptinError500Response:
       type: object
       properties:
         error:
          type: object
          properties:
            code:
              type: string
              example: 500 Internal Server Error
            message:
              type: string
              example: Something went wrong, Please contact MoEngage Team.